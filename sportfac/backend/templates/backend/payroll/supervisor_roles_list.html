{% extends "backend/base.html" %}
{% load i18n sekizai_tags static %}

{% block title %}{% translate "Roles" %} - {{ block.super }}{% endblock %}

{% block page_title %}{% translate "All supervisor roles" %}{% endblock %}

{% get_current_language as LANGUAGE_CODE %}

{% block content %}
  {% addtoblock "js" %}
    <script src="{% static 'js/vendor/js.cookie.js' %}"></script>
    <script src="{% static 'js/vendor/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'js/vendor/datatables/dataTables.bootstrap.js' %}"></script>
    <script>
  $(function () {
    // CSRF setup
    $.ajaxSetup({
      headers: { "X-CSRFToken": Cookies.get("csrftoken") }
    });
    let contractTimers = {};   // per-row debounce timers
    let contractLocks = {};    // per-row request locks
    // Datatables init
    $(".table").dataTable({
      {% if LANGUAGE_CODE == 'fr' %}
      language: { url: "{{ STATIC_URL }}js/vendor/datatables/French.json" },
      {% endif %}
      lengthMenu: [25, 100, -1]
    });

    const updateInstructor = function (id, payload, onSuccess) {
      return $.ajax({
        url: "{% url 'api:course-instructors-list' %}" + id + "/",
        type: "PATCH",
        data: payload,
        success: onSuccess
      });
    };

    $(".table").on("change", "select.function", function () {
      const $row = $(this).closest("tr");
      const id = $row.data("id");
      const value = $(this).val() || null; // empty → null
      const $success = $(this).siblings(".success");
      updateInstructor(id, { function: value }, function () {
        $success.show().fadeOut(2500);
      });
    });

    let contractTimer = null;

    $(".table").on("input", "input.contract-number", function () {
      const $input = $(this);
      const $row = $input.closest("tr");
      const id = $row.data("id");
      const rawValue = $input.val();
      const value = rawValue.trim() === "" ? null : rawValue.trim();
      const $success = $input.siblings(".success");
      const $error = $input.siblings(".error-msg");

      // Clear previous timer
      clearTimeout(contractTimers[id]);

      // Debounce 500ms
      contractTimers[id] = setTimeout(function () {
        // If a request is already running for this row → delay
        if (contractLocks[id]) {
          // retry in 300 ms
          contractTimers[id] = setTimeout(() => $input.trigger("input"), 300);
          return;
        }

        // Lock this row
        contractLocks[id] = true;

        updateInstructor(
          id,
          { contract_number: value },
          function (data) {
            // SUCCESS → update last known value
            $input.data("last-value", rawValue);
            $error.hide();
            $success.show().fadeOut(2000);
            contractLocks[id] = false;
          }).fail(function (xhr) {
            // ---- ERROR ----
            contractLocks[id] = false;

            // rollback to last good value
            const rollback = $input.data("last-value") || "";
            $input.val(rollback);

            // show error
            let msg = "Error";
            if (xhr.responseJSON && xhr.responseJSON.contract_number) {
              msg = xhr.responseJSON.contract_number.join(" ");
            }
            $error.text(msg).show().fadeOut(5000);
          });
        }, 500);
    });
  });
</script>


  {% endaddtoblock %}

  <table class="table">
    <thead>
    <tr>
      <th class="text-nowrap">{% translate "Course" %}</th>
      <th class="text-nowrap">{% translate "Supervisor" %}</th>
      <th class="text-nowrap">{% translate "Role" %}</th>
      <th class="text-nowrap">{% translate "Contract #" %}</th>
      {% if FICHE_SALAIRE_MONTREUX %}
        <th class="text-nowrap">{% translate "Actions" %}</th>
      {% endif %}
    </tr>
    </thead>
    {% for course_instructor in object_list %}
      <tr data-id="{{ course_instructor.id }}">
        <td data-order="{{ course_instructor.course.short_name }}">
          <a href="{{ course_instructor.course.backend_absences_url }}">{{ course_instructor.course.short_name }}</a>
        </td>
        <td data-order="{{ course_instructor.instructor.full_name }}"
            data-search="{{ course_instructor.instructor.full_name }} {{ course_instructor.instructor.external_identifier }}">
          <a href="{{ course_instructor.instructor.get_backend_url }}">
            {{ course_instructor.instructor.full_name }}
            <code>({{ course_instructor.instructor.external_identifier|default:"n/a" }})</code>
          </a>
        </td>
        <td>
          <select class="function form-control">
            {% if not course_instructor.function %}
              <option value="">---</option>
            {% endif %}
            {% for function in functions %}
              <option value="{{ function.name }}" {% if function == course_instructor.function %}selected{% endif %}>
                {{ function.name }} ({{ function.code }})
              </option>
            {% endfor %}
          </select>
          <i class="icon-ok success" style="display: none"></i>
        </td>
        <td>
          <input type="text" class="contract-number form-control"
                 value="{{ course_instructor.contract_number|default:"" }}"
                 data-last-value="{{ course_instructor.contract_number|default:"" }}"
          />
                    <i class="icon-ok success" style="display: none"></i>
          <span class="error-msg text-danger" style="display:none"></span>


        </td>
        {% if FICHE_SALAIRE_MONTREUX %}
          <td>
            <a href="{% url 'backend:pay-slip-montreux' course=course_instructor.course.pk instructor=course_instructor.instructor.pk %}"
               class="btn btn-sm">
              <i class="icon-doc-text"></i> {% translate "Create pay slip" %}
            </a>
          </td>
        {% endif %}

      </tr>
    {% endfor %}
  </table>
{% endblock content %}
