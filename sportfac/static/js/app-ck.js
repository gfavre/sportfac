"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){t===null?t=0:t<0&&(t=Math.max(0,this.length+t));for(var n=t,r=this.length;n<r;n++)if(this[n]===e)return n;return-1});var sportfacModule=angular.module("sportfac",["sportfac.services","ui.calendar"]);sportfacModule.factory("$store",function(e){var t=typeof window.localStorage=="undefined"?undefined:window.localStorage,n=typeof t!="undefined"&&typeof window.JSON!="undefined",r={parseValue:function(e){var t;try{t=JSON.parse(e);typeof t=="undefined"&&(t=e);t=="true"&&(t=!0);t=="false"&&(t=!1);parseFloat(t)==t&&!angular.isObject(t)&&(t=parseFloat(t))}catch(n){t=e}return t}},i={set:function(e,i){if(!n)try{$.cookie(e,i);return i}catch(s){console.log("Local Storage not supported, make sure you have the $.cookie supported.")}var o=JSON.stringify(i);t.setItem(e,o);return r.parseValue(o)},get:function(e){if(!n)try{return r.parseValue($.cookie(e))}catch(i){return null}var s=t.getItem(e);return r.parseValue(s)},remove:function(e){if(!n)try{$.cookie(e,null);return!0}catch(r){return!1}t.removeItem(e);return!0},bind:function(t,n){i.get(n)||i.set(n,[]);e(n).assign(t,i.get(n));t.$watch(n,function(e){i.set(n,e)},!0);return t[n]}};return i});sportfacModule.config(["$routeProvider",function(e){e.when("/activity/:activityId/timeline",{templateUrl:"/static/partials/timeline.html",controller:"ActivityTimelineCtrl"});e.when("/activity/:activityId/detail",{templateUrl:"/static/partials/activity-detail.html",controller:"ActivityDetailCtrl"});e.otherwise({redirectTo:"/activities"})}]);sportfacModule.config(function(e){e.startSymbol("{[{");e.endSymbol("}]}")});var ActivityCtrl=function(e,t,n){e.getUserChildren=function(){t.get("/api/family/").success(function(t){e.userChildren=t;for(var r=0;r<t.length;r++)n.bind(e,"registeredCourses_"+t[r].id);e.selectChild(0)})};e.selectChild=function(t){e.selectedChild&&(e.selectedChild.selected=!1);e.selectedChild=e.userChildren[t];e.selectedChild.selected=!0;e.selectedChild.registered=e["registeredCourses_"+e.selectedChild.id]};e.getDetailedActivity=function(e,n){var r="/api/activities/"+e;t({url:r,method:"GET",cache:!0}).success(function(e){n(e)})};e.selectActivity=function(t){e.selectedActivity&&(e.selectedActivity.selected=!1);t.selected=!0;e.selectedActivity=t};e.isRegistered=function(t){return e.selectedChild.registered.indexOf(t.id)!=-1};e.isAvailable=function(t){return!(e.selectedChild.school_year<t.schoolyear_min||e.selectedChild.school_year>t.schoolyear_max)};e.$watch("selectedChild",function(){e.othersRegisteredEvents.length=0;angular.forEach(e.userChildren,function(t){t!=e.selectedChild&&e.othersRegisteredEvents.push.apply(e.othersRegisteredEvents,e["registeredCourses_"+t.id])})});e.othersRegisteredEvents=[];e.getUserChildren()},ActivityListCtrl=function(e,t){e.loadActivities=function(){var n="/api/activities/?year="+e.selectedChild.school_year;e.activities=t({method:"GET",url:n,cache:!0}).then(function(e){return e.data})};e.$watch("selectedChild",function(){e.loadActivities()})},ActivityTimelineCtrl=function(e,t,n,r){e.activityId=t.activityId;e.events=[];e.registeredEvents=[];e.othersEvents=[];var i=new Date,s=i.getDate(),o=i.getMonth(),u=i.getFullYear();e.getCourse=function(e,t){var n="/api/courses/"+e;r({url:n,method:"GET",cache:!0}).success(function(e){t(e)})};e.getStartDate=function(e){return new Date(u,o,s+(e.day-i.getDay()),e.start_time.split(":")[0],e.start_time.split(":")[1])};e.getEndDate=function(e){return new Date(u,o,s+(e.day-i.getDay()),e.end_time.split(":")[0],e.end_time.split(":")[1])};e.convertCourse=function(t,n){return{title:t.activity.name,start:e.getStartDate(t),end:e.getEndDate(t),start_text:s,end_text:s,allDay:!1,className:n,course:t,activityId:t.activity.id}};e.reloadRegisteredEvents=function(){e.registeredEvents.length=0;for(var t=0;t<e.selectedChild.registered.length;t++)e.getCourse(e.selectedChild.registered[t],function(t){e.registeredEvents.push(e.convertCourse(t,"registered"))})};e.reloadOthersEvents=function(){e.othersEvents.length=0;for(var t=0;t<e.othersRegisteredEvents.length;t++)e.getCourse(e.othersRegisteredEvents[t],function(t){e.registeredEvents.push(e.convertCourse(t,"unavailable"))})};e.changeActivity=function(t){e.events.length=0;for(var n=0;n<t.courses.length;n++){var r=t.courses[n];if(e.isRegistered(r))continue;if(r.schoolyear_min>e.selectedChild.school_year||r.schoolyear_max<e.selectedChild.school_year)continue;var a=new Date(u,o,s+(r.day-i.getDay()),r.start_time.split(":")[0],r.start_time.split(":")[1]),f=new Date(u,o,s+(r.day-i.getDay()),r.end_time.split(":")[0],r.end_time.split(":")[1]);e.events.push({title:t.name,start:a,end:f,start_text:s+(r.day-i.getDay()),end_text:s+r.day-i.getDay(),allDay:!1,className:e.isRegistered(r)?"registered":"available",course:r,activityId:t.id})}};e.eventClick=function(t,n,r){e.$apply(function(){if(!e.isAvailable(t.course))return;var n=t.course.id,r=e.selectedChild.registered.indexOf(n);if(r===-1){t.className="registered";e.selectedChild.registered.push(n)}else{t.className="available";e.selectedChild.registered.splice(r,1);t.activityId!==e.activityId?e.weekagenda.fullCalendar("removeEvents",t._id):e.weekagenda.fullCalendar("updateEvent",t)}e.weekagenda.fullCalendar("rerenderEvents")})};e.uiConfig={calendar:{height:500,aspectRatio:2,year:u,month:o,date:s,editable:!1,defaultView:"agendaWeek",weekends:!1,allDaySlot:!1,slotMinutes:15,firstHour:12,maxTime:20,minTime:12,axisFormat:"H:mm",columnFormat:"dddd",header:{left:"",center:"",right:""},dayNames:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"],dayNamesShort:["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"],timeFormat:{agenda:"d"},lazyFetching:!0,eventClick:e.eventClick,eventAfterRender:function(e,t,r){var i=n("date")(e.course.start_date,"shortDate")+" - "+n("date")(e.course.end_date,"shortDate");$(".fc-event-time",t).text(i)}}};e.getDetailedActivity(e.activityId,function(t){e.detailedActivity=t;e.changeActivity(t);e.reloadRegisteredEvents();e.reloadOthersEvents();e.weekagenda.fullCalendar("render");e.weekagenda.fullCalendar("refetchEvents")});e.eventSources=[e.registeredEvents,e.events]},ActivityDetailCtrl=function(e,t){e.activityId=t.activityId;e.activityId!==undefined&&e.getDetailedActivity({id:e.activityId})};