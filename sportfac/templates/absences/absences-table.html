{% load i18n %}
{% load duration switzerland sekizai_tags staticfiles matrix status mathfilters %}

<div class="table-responsive">
<table class="table table-bordered table-hover table-condensed absences">
  <thead>
    <tr>
      <th><!-- child name column --></th>
      {% for session in course.sessions.all %}
      <th class="date">
        <span class="session-date">{{ session.date | date:"d.m.Y" }}</span>
        <!--<a href="" class="session-edit-date hidden-print"><i class="icon-pencil"></i></a>-->
        &nbsp;      
        <span class="date datetimepicker session-update hidden-print" 
             data-session-url="{{ session.get_api_url }}" >
          <a href="#"><i class="icon-calendar"></i></a>
          <input type="hidden" class="form-control" value="{{ session.date | date:'d.m.Y' }}"
                 data-date-pickTime="false"/>
        </span>
        <a href="#" class="session-delete hidden-print" data-session-url="{{ session.get_api_url }}">
          <i class="icon-trash"></i>
        </a>
      </th>
      {% endfor %}
      <th class="hidden-print">
        <a class="btn btn-success btn-sm" id="create_session_button">
          <i class="icon icon-plus"></i>&nbsp;{% trans "New session" %}
        </a>
      </th>
    </tr>
  </thead>
  <tfoot>
    <tr>
      <th>{% trans "Instructor" %}</th>
      {% for session in course.sessions.all %}
      <th>
          <select name="instructor" class="instructor" data-session-url="{{ session.get_api_url }}">
            {% for instructor in course.instructors.all %}
            <option value="{{ instructor.id }}"{% if session.instructor == instructor %} selected{% endif %}>
              {{ instructor.full_name }}
            </option>
            {% endfor %}
            <option value=""{% if not session.instructor %} selected{% endif %}>{% trans "other" %}</option>
          </select>
          <span class="message success" style="display: none"><i class="icon icon-ok-circled text-success"></i></span> 
          <span class="message error" style="display: none"><i class="icon icon-cancel-circled text-danger"></i></span> 

      </th>
      {% endfor %}
      <th class="hidden-print"></th>
    </tr>
  </tfoot>
  <tbody>
  {% for registration in course.participants.all %}
  {% with units=forloop.counter0 %}
    <tr data-child="{{ registration.child.id }}">
        <th class="text-nowrap child-name">
            {% if request.user.is_manager %}
            <a href="{{ registration.child.get_backend_url}}">{{ registration.child.full_name }}</a>
            {% else %}
            {{ registration.child.full_name }}
            {% endif %}
        </th> 
        
        {% for session in course.sessions.all %}
        {% with status=absence_matrix|index:units|index:forloop.counter0 decade=forloop.counter|mul:100 %}
        <td class="{{ status}} {% if status == 'present' %}success{% elif status == 'late' %}info{% else %}danger{% endif %}"
            data-session="{{ session.id }}"
            data-child="{{ registration.child.id }}"
            data-status="{{ status }}">
            <a tabindex="{{ decade|add:units }}" role="button" class="btn btn-sm has-popover"
                             data-toggle="popover" 
                             data-trigger="click focus">{{ status|absence_status }}</a>
        </td>
        {% endwith %}
        {% endfor %}
        <td class="unavailable hidden-print"></td>
    </tr>
  {% endwith %}
  {% endfor %}
  </tbody>  
</table>
</div>

<script type="text/html" id="status-window">
  <form>
    <div class="radio">
      <label>
        <input type="radio" name="status" id="present" value="present" checked>{% trans "Present" %}
      </label>
    </div>
     <div class="radio">
      <label>
        <input type="radio" name="status" id="absent" value="absent">{% trans "Absent" %}
      </label>
    </div>
     <div class="radio">
      <label>
        <input type="radio" name="status" id="excused" value="excused">{% trans "Excused" %}
      </label>
    </div>
    <div class="radio">
      <label>
        <input type="radio" name="status" id="medical" value="medical">{% trans "Medical certificate" %}
      </label>
    </div>
    <div class="radio">
      <label>
        <input type="radio" name="status" id="late" value="late">{% trans "Late" %}
      </label>
    </div>
    </form>
</script>

<script id="column-header" type="text/html">
    <th class="date">
        <span class="session-date"></span>
        
        <span class="date datetimepicker session-update hidden-print">
          <input type="hidden" class="form-control" value=""
                 data-date-pickTime="false" />
          <a href="#" class="hidden-print"><i class="icon-calendar"></i></a>
        </span>
        <a href="#" class="session-delete hidden-print">
          <i class="icon-trash"></i>
        </a>

    </th>
</script>
<script id="column-content" type="text/html">
    <td class="present success"
        data-status="present">
        <a role="button" class="btn btn-sm has-popover"
           data-toggle="popover" 
           data-trigger="click focus">{{ "present"|absence_status }}</a>
    </td>
</script>


{% addtoblock "js" %}
<script src="{% static 'js/vendor/moment-with-locales.min.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap-datetimepicker.min.js' %}"></script>
<script src="{% static 'js/vendor/js.cookie.js' %}"></script>
<script id="instructors-tmpl" type="text/template">
<th>
  <select name="instructor" class="instructor">
    {% for instructor in course.instructors.all %}
    <option value="{{ instructor.id }}"{% if user == instructor %} selected{% endif %}>
        {{ instructor.full_name }}
    </option>
    {% endfor %}
    <option value=""{% if not user in course.instructors.all %} selected{% endif %}>{% trans "other" %}</option>
  </select>
  <span class="message success" style="display: none"><i class="icon icon-ok-circled text-success"></i></span> 
  <span class="message error" style="display: none"><i class="icon icon-cancel-circled text-danger"></i></span> 
</th>
</script>
<script>
$(function(){
    var HUMAN_FMT = 'DD.MM.YYYY';
    var API_FMT = 'YYYY-MM-DD'
    
    $.ajaxSetup({
        headers: { "X-CSRFToken": Cookies.get("csrftoken") }
    });
    
    $('.datetimepicker').datetimepicker({
        language: '{{ LANGUAGE_CODE }}',
        format: HUMAN_FMT,
        icons: {date: 'icon-calendar', 
                up:   'icon-up-open', 
                down: 'icon-down-open'}
    });
    $('.absences').on('dp.change', '.datetimepicker', function(evt){
        var parent = $(this).parent('th');
        evt.stopPropagation();
        
        $.ajax({
            url: $(this).data('session-url'),
            type: 'PUT',
            data: { date: $(this).data('DateTimePicker').date.format(API_FMT),
                    course: {{ course.id }} },
            success: function(response){
                $('.session-date', parent).text(
                    moment(response.date, API_FMT).format(HUMAN_FMT)
                );
            }
        });        
    });
    
    var newSession = function(){
        var parent = $('#create_session_date').parent();
        
        $.ajax({
            url: "{% url 'api:session-list' %}",
            type: 'POST',
            data: { course: {{ course.id }},
                    date: moment().format(API_FMT),
                    instructor: {% if user in course.instructors.all %}{{ user.pk }}{% else %}null{% endif %} },
            success: function(data){
               var $th_tmpl = $($('#column-header').html());
               var date = moment().format(API_FMT);
               $('input', $th_tmpl).val(moment(data.date, API_FMT).format(HUMAN_FMT));
               var url = "{% url 'api:session-list' %}" + data.id + '/';
               $('.session-update', $th_tmpl).data('session-url', url);
               $('.session-delete', $th_tmpl).data('session-url', url);

               $('.datetimepicker', $th_tmpl).datetimepicker({
                 language: '{{ LANGUAGE_CODE }}',
                 format: HUMAN_FMT,
                 icons: {date: 'icon-calendar', 
                         up:   'icon-up-open', 
                         down: 'icon-down-open'}
               });
               $('.session-date',  $th_tmpl).text( 
                    $('.session-update',  $th_tmpl).data('DateTimePicker').date.format(HUMAN_FMT)
               );
               $('.absences thead th:last').before($th_tmpl);
               
               $('.absences tbody tr').each(function(idx){
                  var $td_tmpl = $($('#column-content').html());
                  $td_tmpl.data('session', data.id);
                  $td_tmpl.data('child', $(this).data('child'));
                  $('a', $td_tmpl).attr('tabindex', $('td:last', $(this)).index() * 100 + idx)                  
                  $('td:last', $(this)).before($td_tmpl);
               });
               
               var $instructor_tmpl = $($('#instructors-tmpl').html());
               $('.absences tfoot th:last').before($instructor_tmpl);
               var $inplace = $('.absences tfoot select').last();
               $inplace.data('session-url', url);
           },
        });
    }
    $('#create_session_button').click(newSession);
    
    $('.absences').on('click', '.session-delete', function(evt){
        var parent = $(this).parent();
        $.ajax({
            url: $(this).data('session-url'),
            type: 'DELETE',
            success: function(response){
                var col_nb = parent.index();
                parent.remove();
                $('.absences tr').each(function(){
                    $('td:nth-child(' + col_nb + ')', this).remove();
                });
                $('.absences tfoot th:nth-child(' + col_nb + ')').remove();
            }
        });
        evt.preventDefault();
    });
    
    $('.absences').on('change', 'select.instructor', function(event){
       var parent = $(this).parent();
       $('.message.error', parent).hide();
       $('.message.success', parent).hide();
       $.ajax({
            url: $(this).data('session-url'),
            type: 'PUT',
            data: {'instructor': $(this).val() },
            success: function(response){
                $('.message.success', parent).show();
            },
            error: function(response){
                $('.message.error', parent).show();
            }
        });

    });
    
        
    $('.absences').on('change', 'input[name=status]', function(event){
        var parent = $(this).parents('td');
        var status =  $(this).val();
        var data = {
            'session': parent.data('session'),
            'child': parent.data('child'),
            'status': status
        }
        
        $.ajax({
            url: "{% url 'api:absence-set' %}",
            type: 'POST',
            data: data,
            success: function(response){
                var label = '';
                var classes = '';
                switch(response.status){
                    case 'present':
                        label = "{% trans 'Present' %}";
                        classes = "success present";
                        break;
                    case 'absent':
                        label = "{% trans 'Absent' %}";
                        classes = "danger absent";
                        break;
                    case 'excused':
                        label = "{% trans 'Excused' %}";
                        classes = "danger excused";
                        break;
                    case 'medical':
                        label = "{% trans 'Medical certificate' %}";
                        classes = "danger medical";
                        break;
                    case 'late':
                        label = "{% trans 'Late arrival' %}";
                        classes = "info late";
                        break;
                }
                $('a', parent).text(label);
                parent.removeClass().addClass(classes);
                parent.data('status', response.status);
                $('.has-popover', parent).popover('hide');
            }
        })
    });
    $('.absences').popover(
        {
            selector: '.has-popover',
            content: function(){ return $('#status-window').html(); },
            html: true
        }
    );
    $('.absences td').on('shown.bs.popover', function(){
        var status = $(this).data('status');
        var $popover_btn = $('.has-popover', $(this));
        $('input[value=' + status + ']', $(this)).prop('checked', true);
    });
});
</script>
{% endaddtoblock %}