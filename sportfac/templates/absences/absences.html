{% extends "base.html" %}
{% load i18n %}
{% load duration switzerland sekizai_tags staticfiles matrix status %}

{% block title %}{{ course.activity.name }} - {% trans "Absences" %}{{ block.super }}{% endblock %}
{% block page_title %}{{ course.activity.name }} - {% blocktrans with identifier=course.number %}course #{{ identifier }} - Absences{% endblocktrans %}{% endblock %}

{% block content %}
<div class="table-responsive">
<table class="table table-bordered table-hover table-condensed absences">
  <thead>
    <tr>
      <th><!-- child name column --></th>
      {% for session in course.sessions.all %}
      <th class="date">
        <span class="session-date">{{ session.date | date:"d.m.Y" }}</span>
        <a href="" class="session-edit-date"><i class="icon-pencil"></i></a>
        <a href="" class="session-delete" data-session-url="{{ session.get_api_url }}">
            <i class="icon-trash"></i>
        </a>
        <div class="input-group date datetimepicker session-update" 
            data-session-url="{{ session.get_api_url }}" 
            style="display: none">
          <input type="text" class="form-control" value="{{ session.date | date:'d.m.Y' }}"
                 data-date-pickTime="false"/>
          <span class="input-group-addon">
            <span class="icon-calendar"></span>
          </span>
        </div>
      </th>
      {% endfor %}
      <th >
        <span class="session-date" style="display: none"></span>
        <a href="" class="session-edit-date" style="display: none"><i class="icon-pencil"></i></a>
        <a href="" class="session-delete" data-session-url="{{ session.get_api_url }}" style="display: none">
            <i class="icon-trash"></i>
        </a>
        <div class="input-group date datetimepicker session-update"  id="create_session_date" style="display: none">
          <input type="text" class="form-control" value="{% now 'd.m.Y' %}"
                 data-date-pickTime="false"/>
          <span class="input-group-addon">
            <span class="icon-calendar"></span>
          </span>
        </div>
        <a class="btn btn-success btn-sm" id="create_session_button">
          <i class="icon icon-plus"></i>&nbsp;{% trans "New session" %}
        </a>
      </th>
    </tr>
  </thead>
  <tbody>
  {% for registration in course.participants.all %}
    <tr data-child="{{ registration.child.id }}">
        <th class="text-nowrap">{{ registration.child.full_name }}</th> 
        {% for session in course.sessions.all %}
        {% with status=absence_matrix|index:forloop.parentloop.counter0|index:forloop.counter0 %}

        <td class="{{ status}} {% if status == 'present' %}success{% elif status == 'late' %}info{% else %}danger{% endif %}"
            data-session={{ session.id }}
            data-child={{ registration.child.id }}>
            <a tabindex="{{ forloop.counter }}" role="button" class="btn btn-sm has-popover"
                             data-toggle="popover" 
                             data-trigger="click focus">{{ status|absence_status }}</a>
        </td>
        {% endwith %}       

        {% endfor %}
        <td class="current-session unavailable ">
            <a tabindex="{{ forloop.counter }}" role="button" class="btn btn-sm has-popover"
                             data-toggle="popover" 
                             data-trigger="click focus">{% trans "Present" %}</a>
        </td>
    </tr>
  {% endfor %}
  </tbody>  
</table>
</div>
<div class="hide" id="status-window">
  <form>
    <div class="radio">
      <label>
        <input type="radio" name="status" id="present" value="present" checked>{% trans "Present" %}
      </label>
    </div>
     <div class="radio">
      <label>
        <input type="radio" name="status" id="absent" value="absent">{% trans "Absent" %}
      </label>
    </div>
     <div class="radio">
      <label>
        <input type="radio" name="status" id="excused" value="excused">{% trans "Excused" %}
      </label>
    </div>
     <div class="radio">
      <label>
        <input type="radio" name="status" id="late" value="late">{% trans "Late" %}
      </label>
    </div>
    </form>
</div>

{% endblock content %}

{% block extra_js %}
<script src="{{ STATIC_URL }}js/vendor/moment-with-locales.min.js"></script>
<script src="{{ STATIC_URL }}js/vendor/bootstrap-datetimepicker.min.js"></script>
<script src="{% static 'js/vendor/js.cookie.js' %}"></script>


<script>
$(function(){
    var HUMAN_FMT = 'DD.MM.YYYY';
    var API_FMT = 'YYYY-MM-DD'
    
    $.ajaxSetup({
        headers: { "X-CSRFToken": Cookies.get("csrftoken") }
    });
    
    $('.datetimepicker').datetimepicker({
        language: '{{ LANGUAGE_CODE }}',
        format: HUMAN_FMT,
        icons: {date: 'icon-calendar', 
                up:   'icon-up-open', 
                down: 'icon-down-open'}
    });
    $('.datetimepicker').on('dp.change', function(evt){
        var parent = $(this).parent();
        $.ajax({
            url: $(this).data('session-url'),
            type: 'PUT',
            data: { date: $(this).data('DateTimePicker').date.format(API_FMT),
                    course: {{ course.id }} },
            success: function(response){
                $('.session-date', parent).text( 
                    $('.session-update', parent).data('DateTimePicker').date.format(HUMAN_FMT)
                );
                $('.session-edit-date', parent).toggle();
                $('.session-delete', parent).toggle();
                $('.session-date', parent).toggle();
                $('.session-update', parent).toggle();
            }
        });        
    });
    
    var newSession = function(){
        var parent = $('#create_session_date').parent();
        
        $.ajax({
            url: "{% url 'api:session-list' %}",
            type: 'POST',
            data: { course: {{ course.id }},
                    date: $('#create_session_date').data('DateTimePicker').date.format(API_FMT)
            },
            success: function(data){
               $('.session-update', parent).data('session-url', "{% url 'api:session-list' %}" + data.id + '/');
               $('.session-date', parent).text( 
                    $('.session-update', parent).data('DateTimePicker').date.format(HUMAN_FMT)
               );
               $('.session-edit-date', parent).toggle();
               $('.session-delete', parent).toggle();
               $('.session-date', parent).toggle();
               $('.session-update', parent).toggle();
           },
        });
    }
    $('.session-edit-date').click(function(evt){
        var parent = $(this).parent();
        $('.session-edit-date', parent).toggle();
        $('.session-delete', parent).toggle();
        $('.session-date', parent).toggle();
        $('.session-update', parent).toggle();
        evt.preventDefault();
    });
    
    $('.session-delete').click(function(evt){
        var parent = $(this).parent();
        $.ajax({
            url: $(this).data('session-url'),
            type: 'DELETE',
            success: function(response){
                var col_nb = parent.index();
                parent.remove();
                $('.absences tr').each(function(){
                    $('td:nth-child(' + col_nb + ')', this).remove();
                });
            }
        });
        evt.preventDefault();
    });
    
    
    
    $('#create_session_button').click(function(evt){
        $(this).hide();
        $('#create_session_date').show();
        $('.current-session').removeClass('unavailable').addClass('available').addClass('success');
        newSession();
    });
    
    $('body').on('change', 'input[name=status]', function(event){
        var parent = $(this).parents('td');
        var data = {
            session: $(this).parents('td').data('session'),
            child: $(this).parents('td').data('child'),
            status: $(this).val()
        }
        $.ajax({
            url: "{% url 'api:absence-list' %}",
            type: 'POST',
            data: data,
            success: function(response){
                console.log(response);
                var label = '';
                var classes = '';
                switch(response.status){
                    case 'present':
                        label = "{% trans 'Present' %}";
                        classes = "success present";
                        break;
                    case 'absent':
                        label = "{% trans 'Absent' %}";
                        classes = "danger absent";
                        break;
                    case 'excused':
                        label = "{% trans 'Excused' %}";
                        classes = "danger excused";
                        break;
                    case 'late':
                        label = "{% trans 'Late arrival' %}";
                        classes = "info late";
                        break;
                }
                $('a', parent).text(label);
                parent.removeClass().addClass(classes);
                $('.has-popover', parent).popover('hide');
            }
        })
    });
    $('.absences').popover(
        {
            selector: '.has-popover',
            content: function(){
                var window = $('#status-window').html();
                return window;
            },
            html: true
        }
    );
});
</script>
{% endblock %}