{% extends "backend/base.html" %}
{% load i18n sekizai_tags %}
{% load duration switzerland %}

{% block title %}{{ course.activity.name }} - {{ block.super }}{% endblock %}
{% block page_title %}
    {{ course.activity.name }} - {% blocktrans with identifier=course.number %}course #{{ identifier }}{% endblocktrans %}
    {% if CALENDAR_DISPLAY_COURSE_NAMES and course.name %}
    - {{ course.name }}
    {% endif %}
{% endblock %}

{% block content %}
<section class="portlet">
  <div class="pricing-plan">
    <header class="pricing-header">
      <p class="pricing-plan-label">{{ course.start_date | date:"j F Y" }} – {{ course.end_date | date:'j F Y'  }}</p>
      <p class="lead">Chaque {{ course.day_name|lower }} de {{ course.start_time|time:"H:i" }} à {{ course.end_time|time:"H:i" }} ({{ course.duration|duration }})</p>
    </header>
    <dl class="dl-horizontal">
      <dt>{% trans "Course number" %}</dt><dd><a href="{{ course.activity.get_backend_url }}">{{ course.activity.number }}</a></dd>
      <dt>{% trans "Instructors" %}</dt>
      <dd>
        <ul class="list-unstyled">
        {% for instructor in course.instructors.all %}
          <li><a href="{{ instructor.get_backend_url }}">{{ instructor.full_name  }}</a></li>
        {% endfor %}
        </ul>
      </dd>
      <dt>{% trans "Place" %}</dt><dd>{{ course.place  }}</dd>
      <dt>{% trans "Number of sessions" %}</dt><dd>{{ course.number_of_sessions }} cours</dd>
      {% if not NO_PAYMENT %}
      <dt>{% trans "Price" %}</dt><dd>{{ course.price|money }}</dd>
      {% endif %}
      <dt>{% trans "School years" %}</dt>
      <dd>{% for year in course.school_years %}{{year}}P{% if not forloop.last %} - {% endif %} {% endfor %}</dd>
      <dt>{% trans "Extra questions" %}</dt>
      <dd>
        <ul class="list-unstyled">
        {% for extra in course.extra.all %}
          <li>{{ extra.question_label }}{% if extra.choices %}: ({{ extra.choices|join:", " }}){% endif %}</li>
        {% empty %}
            <li>{% trans "No extra question required" %}</li>
        {% endfor %}
        </ul>
      </dd>
    </dl>
    <p class="text-center"><a href="{{ course.get_update_url }}" class="btn btn-default"><i class="icon-edit"></i>&nbsp;{% trans "Edit" %}</a> </p>
      
    <h4 class="content-title"><u>{% trans "Availability"%}</u></h4>      
    <p>{{ course.count_participants  }} participants <span class="pull-right strong"> {{ course.max_participants }} places</span></p>
    <div class="progress" style="margin-bottom: 0;">
      <div class="progress-bar {% if course.full %}progress-bar-danger{% elif course.minimal_participants_reached %}progress-bar-success{% else %}progress-bar-warning{% endif %}" style="width: {{ course.percentage_full }}%">{% if course.full %}{% trans "Course full" %}{% elif course.minimal_participants_reached %}{% trans "Minimal number of participants reached" %}{% else %}{% trans "Not enough participants" %}{% endif %}</div>
    </div>
    <p class="text-right"><small>{{ course.min_participants }} participants requis pour que l'activité ait lieu</small></p>
    
    {% if course.count_participants %}
      <h4 class="content-title"><u>{% trans "Management"%}</u></h4>

      <a href="{{ course.get_custom_mail_url }}" class="btn btn-default">
        <i class="icon-mail"></i>&nbsp;{% trans "Mail all participants" %}
      </a>&nbsp;
      {% if USE_ABSENCES %}
      <a href="{{ course.get_backend_absences_url }}" class="btn btn-default">
        <i class="icon-calendar"></i>&nbsp;{% trans "Manage absences" %}
      </a>
      {% endif %}
    {% endif %}
  </div>
</section>

{% if course.count_participants %}

{% addtoblock  "js" %}
<script src="{{ STATIC_URL }}js/vendor/datatables/jquery.dataTables.min.js"></script>
<script src="{{ STATIC_URL }}js/vendor/datatables/dataTables.tableTools.min.js"></script>
<script src="{{ STATIC_URL }}js/vendor/datatables/dataTables.bootstrap.js"></script>
<script>
$(function () {
  $(".table").dataTable({
{% if LANGUAGE_CODE == 'fr' %}
      "language": {
            "url": "{{ STATIC_URL }}js/vendor/datatables/French.json"
      },
{% endif %}
      aoColumnDefs: [
          { 'bSortable': false, 'bSearchable': false, 'aTargets': [ -1] }
      ],
      paging: false

  });
});
</script>
{% endaddtoblock %}

<section>
  <h2>{% trans "Registrations" %}</h2>
  
  <table class="table">
    <thead>
      <tr>
        <th>{% trans "Name" %}</th>
        <th>{% if CHILD_SCHOOL %}{% trans "School infos" %}{% else %}{% trans "School year" %}{% endif %}</th>
        {% if EMERGENCY_NUMBER_MANDATORY %}
        <th>{% trans "Emergency number" %}</th>
        {% else %}
        <th>{% trans "Parents phone" %}</th>
        {% endif %}
        <th>{% trans "Parents email" %}</th>
        {% for extra in course.extra.all %}
        <th>{{ extra.question_label }}</th>
        {% endfor %}
        <th>{% trans "Status" %}</th>
        <th>{% trans "Actions" %}</th>
      </tr>
    </thead>
    <tbody>
    {% for registration in registrations %}
      <tr>
        <td>
            <a href="{{ registration.child.get_backend_url }}">{{ registration.child.full_name }}</a>
        </td>

        <td>
            {{ registration.child.school_year|default:"n/a" }}
            {% if CHILD_SCHOOL %}<br>
            {{ registration.child.school_name }}
            {% endif %}
        </td>
        {% if EMERGENCY_NUMBER_MANDATORY %}
        <td>
            <a href="{{ registration.child.emergency_number|phone:'RFC3966' }}">
                {{ registration.child.emergency_number|phone }}
            </a>
        </td>
        {% else %}
        <td>
          <ul>
            {% if registration.child.family.private_phone %}
            <li>
              <a href="{{ registration.child.family.private_phone|phone:'RFC3966' }}">
                {{ registration.child.family.private_phone|phone }}
              </a>
            </li>
            {% endif %}
            {% if registration.child.family.private_phone2 %}
            <li>
              <a href="{{ registration.child.family.private_phone2|phone:'RFC3966' }}">
                {{ registration.child.family.private_phone2|phone }}
              </a>
            </li>
            {% endif %}
            {% if registration.child.family.private_phone3 %}
            <li>
              <a href="{{ registration.child.family.private_phone3|phone:'RFC3966' }}">
                {{ registration.child.family.private_phone3|phone }}
              </a>
            </li>
            {% endif %}
        </td>
        {% endif %}


        <td>{{ registration.child.family.email | urlize }}</td>
      {% for extra in registration.extra_infos.all %}
        <td data-order="{{ extra.value }}">
        {% if extra.key.type == 'B' %}
            {% if extra.value == '1' %}
            <i class="icon-ok-circled text-success"></i>
            {% else %}
            <i class="icon-cancel-circled text-danger"></i>
            {% endif %}
        {% else %}
            {{ extra.value }}
        {% endif %}
        </td>
      {% empty %}
        {% for extra in course.extra.all %}
        <td></td>
        {% endfor %}
      {% endfor %}
        <td>{{ registration.get_status_display }}</td>

        <td>
          <ul class="list-unstyled">
            <li class="text-nowrap"><a href="{% url 'backend:registration-update' pk=registration.pk %}?course={{ course.number }}" class="btn btn-sm"><i class="icon-edit"></i>&nbsp;{% trans "Update registration" %}</a></li>
            <li class="text-nowrap"><a href="{% url 'backend:registration-delete' pk=registration.pk %}" class="btn btn-sm"><i class="icon-cancel"></i>&nbsp;{% trans "Cancel registration" %}</a></li>
          </ul>
        </td>

      </tr>
    {% empty %}

    {% endfor %}
    </tbody>
  </table>

</section>
{% endif %}
{% endblock content %}