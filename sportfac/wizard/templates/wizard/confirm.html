{% extends "wizard/base.html" %}
{% load crispy_forms_tags humanize duration sekizai_tags switzerland i18n %}


{% block wizard_content %}
  {% if REGISTRATION_EXPIRE_MINUTES %}
    <div class="alert alert-info alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert">
        <span aria-hidden="true">&times;</span><span class="sr-only">{% trans "Close" %}</span>
      </button>
      <p><strong><i class="icon-exclamation"></i></strong>
        {% if REGISTRATION_EXPIRE_MINUTES == 60 %}
          {% blocktrans %}The following registrations are reserved for the next hour.{% endblocktrans %}
        {% else %}
          {% blocktrans with REGISTRATION_EXPIRE_MINUTES|minutes_duration as duration %}
            The following registrations are reserved for the next {{ duration }}.
          {% endblocktrans %}
        {% endif %}
      </p>
    </div>
  {% endif %}

  {% if overlaps %}
    <div class="alert alert-warning alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert">
        <span aria-hidden="true">&times;</span><span class="sr-only">{% trans "Close" %}</span>
      </button>
      <strong><i class="icon-warning"></i>&nbsp;{% trans "Warning!" %}</strong>
      <p>
        {% if user.children.count > 1 %}
          {% trans "The following courses occur at the same or close times. It may be difficult to bring your children." %}
        {% else %}
          {% trans "The following courses occur at the same or close times. It may be difficult to bring your child." %}
        {% endif %}
      <ul>
        {% for overlap in overlaps %}
          <li>
            <span class="highlight"
                  rel="{{ overlap.0.id }}">{{ overlap.0.child.first_name }} - {{ overlap.0.course.activity.name }}</span>
            /
            <span class="highlight"
                  rel="{{ overlap.1.id }}">{{ overlap.1.child.first_name }} - {{ overlap.1.course.activity.name }}</span>
          </li>
        {% endfor %}
      </ul>
      </p>
    </div>
  {% endif %}

  <h4>{% trans "Registrations" %}</h4>
  <table class=" table table-hover ">
    <thead>
    <tr>
      <th class="text-center">{% trans "Name" %}</th>
      <th class="text-center">{% trans "Activity" %}</th>
      <th class="text-center">{% trans "Period" %}</th>
      <th class="text-center">{% trans "Time" %}</th>
      <th class="text-center">{% trans "Place" %}</th>
      {% if not NO_PAYMENT %}
        <th class="text-center">{% trans "Price" %}</th>
      {% endif %}
    </tr>
    </thead>
    <tbody>
    {% for registration in registrations %}
      <tr id="{{ registration.id }}" {% if registration.id in overlapped %}class="warning"{% endif %}>
        <td rowspan="{{ registration.row_span }}" class="text-nowrap">
          <strong>{{ registration.child.full_name }}</strong>
        </td>
        <td>
          <strong>{{ registration.course.activity.name }}</strong>
        </td>
        <td class="text-center">
          <span class="nowrap">{{ registration.course.start_date }}</span><br>
          <span class="icon-down-1" aria-hidden="true"></span><br>
          <span class="nowrap">{{ registration.course.end_date }}</span>
        </td>
        <td class="text-center">
          {{ registration.course.day_name }} <br/> <span
            class="nowrap">{{ registration.course.start_time|time:"H:i" }} - {{ registration.course.end_time|time:"H:i" }}</span>
        </td>
        <td>{{ registration.course.place }}</td>

        {% if not NO_PAYMENT %}
          <td class="nowrap text-right invoice-item" data-value="{{ registration.price }}">
            {% if registration.price %}
              {% with price_category=registration.get_price_category %}
                <strong>{{ price_category.0|money }}</strong>
                {% if price_category.1 %}<br>
                  <small>{{ price_category.1 }}</small>
                {% endif %}
              {% endwith %}
            {% else %}
              <strong>{{ registration.price|money }}</strong>
            {% endif %}
          </td>
        {% endif %}
      </tr>
      {% for answer in registration.extra_infos.all %}
        <tr>
          <td colspan="4">
            {{ answer.key.question_label }} –
            {% if answer.key.is_boolean or answer.key.is_image %}
              <strong><i class="icon-{% if answer.is_true %}ok{% else %}cancel{% endif %}-circled"></i></strong>
            {% else %}
              <strong>{{ answer.value }}</strong>
            {% endif %}
          </td>
          {% if not NO_PAYMENT %}
            <td class="nowrap text-right invoice-item">
              {% if answer.price_modifier %}<strong>{{ answer.price_modifier|money }}</strong>{% endif %}
            </td>
          {% endif %}
        </tr>
      {% endfor %}
    {% endfor %}
    </tbody>
  </table>

  {% if rentals %}
    <h4>{% trans "Rental" %}</h4>
    <table class=" table table-hover ">
      <thead>
      <tr>
        <th class="text-center">{% trans "Name" %}</th>
        <th class="text-center">{% trans "Pickup" %}</th>
        <th class="text-center">{% trans "Return" %}</th>
        {% if not NO_PAYMENT %}
          <th class="text-center">{% trans "Price" %}</th>
        {% endif %}
      </tr>
      </thead>
      <tbody>
      {% for rental in rentals %}
        <tr>
          <td><strong>{{ rental.child.full_name }}</strong></td>
          <td class="text-center">{{ rental.pickup_appointment.slot.start }}</td>
          <td class="text-center">{{ rental.return_appointment.slot.start }}</td>
          {% if not NO_PAYMENT %}
            <td class="text-right"><strong>{{ rental.amount|money }}</strong></td>
          {% endif %}

        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if not NO_PAYMENT %}
    <table class=" table table-hover " style="margin-top: 3em">
      <tfoot>
      <tr>
        <th colspan="4" class="text-right">{% trans "Total" %}</th>
        <th class="text-right">{{ total_amount|money_html }}</th>
      </tr>
      </tfoot>
    </table>
  {% endif %}

  {% if consent_already_given %}
    <div>
      <label for="consent_given">Consentement donné :</label>
      <input type="checkbox" id="consent_given" name="consent_given" checked disabled>
      <p>Date de l'acceptation : {{ validation_date|naturaltime }}</p>
    </div>


  {% else %}

    {% crispy form %}
    {% addtoblock "js" %}
      {{ form.media.js }}
    {% endaddtoblock %}
    {% addtoblock "css" %}
      {{ form.media.css }}
    {% endaddtoblock %}
  {% endif %}
{% endblock %}

{% block page_footer %}
  {% if consent_already_given %}
    <nav class="hidden-print" style="margin-top: 1.5em;">
      <ul class="pager" style="font-size: 1.25em">
        {% if previous_step %}
          <li class="previous">
            <a href="{{ previous_step.url }}"><span aria-hidden="true">&larr;</span>
              {% block previous_label %}{% trans "Previous" %}{% endblock %}</a>
          </li>
        {% endif %}
        {% if next_step %}
          <li class="next">
            <a href="{{ next_step.url }}" id="next-step-btn">
              <strong>{% block next_label %}{% trans "Next" %}{% endblock %} <span
                  aria-hidden="true">&rarr;</span></strong></a>
          </li>

        {% endif %}
      </ul>
    </nav>
  {% endif %}
{% endblock page_footer %}
